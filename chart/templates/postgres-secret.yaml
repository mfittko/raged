{{- $secretName := printf "%s-postgres-secret" .Release.Name -}}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName -}}
{{- $existingPassword := (dig "data" "POSTGRES_PASSWORD" "" $existingSecret) | b64dec -}}
{{- $password := .Values.postgres.password | default $existingPassword | default (randAlphaNum 32) -}}
{{- $encodedUser := replace "+" "%20" (urlquery .Values.postgres.user) -}}
{{- $encodedPassword := replace "+" "%20" (urlquery $password) -}}
{{- $encodedDatabase := replace "+" "%20" (urlquery .Values.postgres.database) -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-postgres-secret
  labels:
    {{- include "rag.labels" . | nindent 4 }}
type: Opaque
stringData:
  POSTGRES_USER: "{{ .Values.postgres.user }}"
  POSTGRES_PASSWORD: "{{ $password }}"
  # URL encoding for reserved characters. Spaces are normalized to %20 for broad client compatibility.
  DATABASE_URL: "postgresql://{{ $encodedUser }}:{{ $encodedPassword }}@{{ .Release.Name }}-postgres:{{ .Values.postgres.service.port }}/{{ $encodedDatabase }}"
